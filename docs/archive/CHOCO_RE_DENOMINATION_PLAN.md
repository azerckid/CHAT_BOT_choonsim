# CHOCO 경제 엔진 전면 개편 및 마이그레이션 플랜 (V1.0)

**작성일**: 2026-01-13  
**대상**: 기축 가치 변경 ($1 = 1,000 CHOCO)에 따른 전 시스템 로직 수정  
**상태**: ✅ 구현 및 검증 완료 (2026-01-13)  
**목표**: 유저 보유 CHOCO 가치 보호 및 향후 고비용(그림/영상) 기능 도입을 위한 토대 마련

---

## 1. 개요 (Rational)

CHOCO의 기축 가치를 기존 `$0.0001`에서 **`$0.001`**로 10배 상향 조정함에 따라, 시스템 전반의 수치 계산 로직을 전면 수정해야 합니다. 
단순히 환율만 바꾸는 것이 아니라, **차감량(채팅 비용)**과 **충전 단위(Silent Payment)**를 동시에 조정하여 유저 경험을 최적화합니다.

---

## 2. 주요 수정 영역 (Impact Scope)

### 2.1 채팅 과금 로직 수정 (`app/routes/api/chat/index.ts`)
*   **현상**: 현재 `1 토큰 = 1 CHOCO`로 차감되어, 채팅 1회당 약 1,000 CHOCO($1)가 소모되는 초고가 구조.
*   **변경**: **`1,000 토큰(채팅 약 1회) = 10 CHOCO`** ($0.01) 차감으로 수정.
*   **공식**: `Deduction = (TotalTokens / 100)`
*   **효과**: 1달러 결제 시 약 100회 대화 가능 (안전 마진 약 90% 확보).

### 2.2 X402 인보이스 엔진 수정 (`app/lib/near/x402.server.ts`)
*   **현상**: 인보이스 생성 시 가치 산정 기준이 `$0.0001`로 고정됨.
*   **변경**: `chocoPriceUSD = 0.001`로 업데이트.
*   **효과**: 외부 결제 및 온체인 인보이스 생성 시 정확한 $1 : 1,000 비율 유지.

### 2.3 Silent Payment (자동 소액 결제) 단위 조정
*   **현상**: 잔액 부족 시 `$0.01` 단위로 자동 충전 요청.
*   **변경**: **`$0.1` (100 CHOCO)** 단위로 상향.
*   **이유**: 새로운 정책에서 `$0.01`은 채팅 딱 1회 분량에 불과하므로, 결제 횟수를 줄이고 사용자 피로도를 낮추기 위해 단위를 10배 올림.

---

## 3. 마이그레이션 전략 (Data Integrity)

현재 DB에 저장된 유저들의 `chocoBalance`는 기존 가치($0.0001) 기준입니다. 가치가 10배 올랐으므로, 수치를 그대로 두면 유저들은 가만히 앉아서 자산이 10배 불어나는 효과를 보게 되지만, 마진 구조상 이는 서비스에 치명적입니다.

### 3.1 잔액 조정 (Re-denomination)
*   **방법**: 모든 유저의 `chocoBalance`를 **1/10**로 조정.
    - 예: 10,000 CHOCO(기존 가치 $1) → 1,000 CHOCO(신규 가치 $1)
*   **수행 시점**: 시스템 로직 업데이트 직전 DB 마이그레이션 실행.

---

## 4. 실행 체크리스트 (Action Plan)

1.  **[ ] DB 백업**: 현재 유저 잔액 및 결제 기록 풀 덤프 생성.
2.  **[ ] DB 마이그레이션**: 모든 유저의 `chocoBalance = chocoBalance / 10` 업데이트.
3.  **[ ] 서버 코드 업데이트**:
    - `exchange-rate.server.ts`: 기축 가격 수정 (완료)
    - `x402.server.ts`: 인보이스 계산식 수정.
    - `api/chat/index.ts`: 차감량 계산식(토큰 대비 나누기 100) 반영.
4.  **[ ] UI 일괄 확인**: 지갑 및 과금 안내 팝업의 수치 정합성 검토.

---

**결론**: 본 플랜은 CHOCO를 '진짜 화폐'처럼 가치 있게 만들기 위한 필수 과정이며, 이를 통해 향후 그림/영상 생성 등의 프리미엄 기능을 합리적인 가격에 제공할 수 있게 됩니다.
